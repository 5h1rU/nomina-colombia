<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control N√≥mina Colombia 2026</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 8px; font-size: 1.6rem; }
        .subtitle { text-align: center; color: #8892b0; margin-bottom: 24px; font-size: 0.9rem; }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            overflow-x: auto;
        }
        .tab {
            padding: 10px 20px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: transparent;
            color: #8892b0;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab.active { background: #64ffda; color: #1a1a2e; border-color: #64ffda; }
        .tab:hover:not(.active) { border-color: #64ffda; color: #64ffda; }

        .card {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .card h2 { font-size: 1rem; color: #64ffda; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        
        .input-row { display: flex; gap: 12px; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; margin-bottom: 12px; }
        .input-group.small { min-width: 120px; flex: 0.5; }
        label { display: block; margin-bottom: 6px; color: #ccd6f6; font-size: 0.85rem; }
        input, select {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            background: rgba(255,255,255,0.05);
            color: #fff;
            font-size: 0.95rem;
        }
        input:focus, select:focus { outline: none; border-color: #64ffda; }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .btn-primary { background: #64ffda; color: #1a1a2e; }
        .btn-primary:hover { background: #52e0c4; }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #ccd6f6; }
        .btn-secondary:hover { background: rgba(255,255,255,0.2); }
        .btn-danger { background: #ff6b6b; color: #fff; }
        
        /* Calendar */
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .calendar-nav { display: flex; gap: 8px; align-items: center; }
        .calendar-nav button {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.2);
            background: transparent;
            color: #fff;
            cursor: pointer;
        }
        .calendar-nav button:hover { border-color: #64ffda; color: #64ffda; }
        .month-year { font-size: 1.1rem; font-weight: 600; min-width: 160px; text-align: center; }
        
        .quincena-toggle {
            display: flex;
            gap: 4px;
            background: rgba(0,0,0,0.2);
            padding: 4px;
            border-radius: 8px;
        }
        .quincena-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: transparent;
            color: #8892b0;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .quincena-btn.active { background: #64ffda; color: #1a1a2e; }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }
        .calendar-day-header {
            text-align: center;
            padding: 8px;
            color: #8892b0;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            border: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }
        .calendar-day:hover { border-color: rgba(255,255,255,0.3); }
        .calendar-day.empty { cursor: default; }
        .calendar-day.empty:hover { border-color: transparent; }
        .calendar-day.today { border-color: #64ffda; }
        .calendar-day.future { opacity: 0.4; cursor: not-allowed; }
        .calendar-day.outside-quincena { opacity: 0.3; }
        
        .calendar-day.worked { background: #2ecc71; color: #fff; }
        .calendar-day.absent { background: #e74c3c; color: #fff; }
        .calendar-day.vacation { background: #3498db; color: #fff; }
        .calendar-day.sick { background: #9b59b6; color: #fff; }
        .calendar-day.holiday { background: #f39c12; color: #fff; }
        .calendar-day.half { background: linear-gradient(135deg, #2ecc71 50%, #e74c3c 50%); color: #fff; }
        .calendar-day.sunday { color: #ff6b6b; }
        
        .calendar-day .indicator {
            font-size: 0.6rem;
            position: absolute;
            bottom: 2px;
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #8892b0;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .legend-item:hover { background: rgba(255,255,255,0.1); }
        .legend-item.selected { background: rgba(255,255,255,0.2); }
        .legend-dot {
            width: 14px; height: 14px;
            border-radius: 4px;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
        }
        .stat-box {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 12px;
            text-align: center;
        }
        .stat-value { font-size: 1.3rem; font-weight: 700; color: #64ffda; }
        .stat-label { font-size: 0.7rem; color: #8892b0; margin-top: 4px; }
        
        /* Summary rows */
        .row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .row:last-child { border-bottom: none; }
        .row .label { color: #8892b0; }
        .row .value { font-weight: 600; color: #ccd6f6; }
        .row.total { 
            margin-top: 8px; padding-top: 12px;
            border-top: 2px solid #64ffda; border-bottom: none;
        }
        .row.total .label, .row.total .value { color: #64ffda; font-size: 1.05rem; }
        .row.highlight { background: rgba(100, 255, 218, 0.1); margin: 0 -20px; padding: 10px 20px; }
        
        /* History */
        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .history-month { font-weight: 600; }
        .history-details { color: #8892b0; font-size: 0.85rem; }
        .history-amount { color: #64ffda; font-weight: 600; }
        
        .section { display: none; }
        .section.active { display: block; }
        
        .info-box {
            background: rgba(100, 255, 218, 0.1);
            border-left: 3px solid #64ffda;
            padding: 12px 16px;
            border-radius: 0 8px 8px 0;
            font-size: 0.85rem;
            color: #8892b0;
            margin-top: 12px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #8892b0;
        }
        .empty-state .icon { font-size: 3rem; margin-bottom: 16px; }
        
        footer {
            text-align: center;
            margin-top: 24px;
            color: #8892b0;
            font-size: 0.75rem;
        }
        
        @media (max-width: 500px) {
            .calendar-day { font-size: 0.75rem; }
            .legend { justify-content: center; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìã Control de N√≥mina</h1>
        <p class="subtitle">Colombia 2026 - Salario M√≠nimo</p>

        <div class="tabs">
            <button class="tab active" onclick="showSection('calendar')">üìÖ Asistencia</button>
            <button class="tab" onclick="showSection('summary')">üí∞ Liquidaci√≥n</button>
            <button class="tab" onclick="showSection('history')">üìä Historial</button>
            <button class="tab" onclick="showSection('settings')">‚öôÔ∏è Config</button>
        </div>

        <!-- Calendar Section -->
        <div id="section-calendar" class="section active">
            <div class="card">
                <div class="calendar-header">
                    <h2 style="margin:0">üìÖ Asistencia</h2>
                    <div class="quincena-toggle">
                        <button class="quincena-btn active" onclick="setQuincena('all')">Mes</button>
                        <button class="quincena-btn" onclick="setQuincena(1)">Q1 (1-15)</button>
                        <button class="quincena-btn" onclick="setQuincena(2)">Q2 (16-fin)</button>
                    </div>
                    <div class="calendar-nav">
                        <button onclick="changeMonth(-1)">‚Üê</button>
                        <span class="month-year" id="monthYear"></span>
                        <button onclick="changeMonth(1)">‚Üí</button>
                    </div>
                </div>
                
                <div class="calendar-grid" id="calendarGrid"></div>
                
                <div class="legend">
                    <div class="legend-item selected" data-type="worked" onclick="selectType('worked')">
                        <div class="legend-dot" style="background:#2ecc71"></div> Trabajado
                    </div>
                    <div class="legend-item" data-type="absent" onclick="selectType('absent')">
                        <div class="legend-dot" style="background:#e74c3c"></div> Ausencia
                    </div>
                    <div class="legend-item" data-type="vacation" onclick="selectType('vacation')">
                        <div class="legend-dot" style="background:#3498db"></div> Vacaciones
                    </div>
                    <div class="legend-item" data-type="sick" onclick="selectType('sick')">
                        <div class="legend-dot" style="background:#9b59b6"></div> Incapacidad
                    </div>
                    <div class="legend-item" data-type="holiday" onclick="selectType('holiday')">
                        <div class="legend-dot" style="background:#f39c12"></div> Festivo
                    </div>
                    <div class="legend-item" data-type="half" onclick="selectType('half')">
                        <div class="legend-dot" style="background:linear-gradient(135deg, #2ecc71 50%, #e74c3c 50%)"></div> Medio d√≠a
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üìä Resumen <span id="quincenaLabel">del Mes</span></h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="statWorked">0</div>
                        <div class="stat-label">Trabajados</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statAbsent">0</div>
                        <div class="stat-label">Ausencias</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statVacation">0</div>
                        <div class="stat-label">Vacaciones</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statSick">0</div>
                        <div class="stat-label">Incapacidad</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statHoliday">0</div>
                        <div class="stat-label">Festivos</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="statSundays">0</div>
                        <div class="stat-label">Domingos</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Section -->
        <div id="section-summary" class="section">
            <div class="card">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
                    <h2 style="margin:0">üí∞ Liquidaci√≥n</h2>
                    <div class="quincena-toggle">
                        <button class="quincena-btn summary-q active" onclick="setSummaryQuincena('all')">Mes</button>
                        <button class="quincena-btn summary-q" onclick="setSummaryQuincena(1)">Q1</button>
                        <button class="quincena-btn summary-q" onclick="setSummaryQuincena(2)">Q2</button>
                    </div>
                </div>
                <p style="color:#64ffda;margin-bottom:16px;" id="summaryPeriod"></p>
                
                <div class="row">
                    <span class="label">D√≠as a pagar (salario)</span>
                    <span class="value" id="diasPagar">0</span>
                </div>
                <div class="row">
                    <span class="label">Salario proporcional</span>
                    <span class="value" id="salarioBase">$0</span>
                </div>
                <div class="row">
                    <span class="label">Auxilio transporte legal (proporcional)</span>
                    <span class="value" id="auxTransporte">$0</span>
                </div>
                <div class="row highlight">
                    <span class="label">üöå Bono transporte (<span id="diasBono">0</span> d√≠as √ó $<span id="bonoValor">0</span>)</span>
                    <span class="value" id="bonoTransporte">$0</span>
                </div>
                <div class="row">
                    <span class="label">(-) Aporte salud (4%)</span>
                    <span class="value" id="descSalud">$0</span>
                </div>
                <div class="row">
                    <span class="label">(-) Aporte pensi√≥n (4%)</span>
                    <span class="value" id="descPension">$0</span>
                </div>
                <div class="row total">
                    <span class="label">Neto a pagar</span>
                    <span class="value" id="netoPagar">$0</span>
                </div>
            </div>

            <div class="card">
                <h2>üè¢ Costo Total Empleador</h2>
                <div class="row">
                    <span class="label">Salario + Auxilios + Bono</span>
                    <span class="value" id="totalDevengado">$0</span>
                </div>
                <div class="row">
                    <span class="label">Prestaciones sociales</span>
                    <span class="value" id="prestaciones">$0</span>
                </div>
                <div class="row">
                    <span class="label">Seguridad social</span>
                    <span class="value" id="segSocial">$0</span>
                </div>
                <div class="row">
                    <span class="label">Parafiscales</span>
                    <span class="value" id="parafiscales">$0</span>
                </div>
                <div class="row total">
                    <span class="label">Costo total</span>
                    <span class="value" id="costoTotal">$0</span>
                </div>
            </div>

            <div class="card">
                <h2>üìã Detalle Prestaciones (provisi√≥n)</h2>
                <div class="row">
                    <span class="label">Prima de servicios (8.33%)</span>
                    <span class="value" id="prima">$0</span>
                </div>
                <div class="row">
                    <span class="label">Cesant√≠as (8.33%)</span>
                    <span class="value" id="cesantias">$0</span>
                </div>
                <div class="row">
                    <span class="label">Intereses cesant√≠as (1%)</span>
                    <span class="value" id="intCesantias">$0</span>
                </div>
                <div class="row">
                    <span class="label">Vacaciones (4.17%)</span>
                    <span class="value" id="vacaciones">$0</span>
                </div>
            </div>
            
            <button class="btn btn-primary" onclick="saveQuincena()" style="width:100%;margin-top:8px;">
                üíæ Guardar Liquidaci√≥n
            </button>
        </div>

        <!-- History Section -->
        <div id="section-history" class="section">
            <div class="card">
                <h2>üìä Historial de Pagos</h2>
                <div id="historyList"></div>
            </div>
            
            <div class="card">
                <h2>üìà Acumulados del A√±o</h2>
                <div class="row">
                    <span class="label">Total pagado al trabajador</span>
                    <span class="value" id="totalPagado">$0</span>
                </div>
                <div class="row">
                    <span class="label">Total costo empleador</span>
                    <span class="value" id="totalCosto">$0</span>
                </div>
                <div class="row">
                    <span class="label">Total bono transporte</span>
                    <span class="value" id="totalBono">$0</span>
                </div>
                <div class="row">
                    <span class="label">D√≠as trabajados</span>
                    <span class="value" id="totalDias">0</span>
                </div>
                <div class="row">
                    <span class="label">Vacaciones tomadas</span>
                    <span class="value" id="totalVacaciones">0 d√≠as</span>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="section-settings" class="section">
            <div class="card">
                <h2>üë§ Datos del Empleado</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label>Nombre completo</label>
                        <input type="text" id="empNombre" placeholder="Nombre del empleado">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>C√©dula</label>
                        <input type="text" id="empCedula" placeholder="N√∫mero de c√©dula">
                    </div>
                    <div class="input-group">
                        <label>Fecha de ingreso</label>
                        <input type="date" id="empFechaIngreso">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>Cargo</label>
                        <input type="text" id="empCargo" placeholder="Cargo o posici√≥n">
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>üíµ Configuraci√≥n de N√≥mina</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label>Salario mensual</label>
                        <input type="number" id="salarioConfig" value="1750905">
                    </div>
                    <div class="input-group">
                        <label>Auxilio transporte legal (mes)</label>
                        <input type="number" id="auxilioConfig" value="249095">
                    </div>
                </div>
                <div class="input-row">
                    <div class="input-group">
                        <label>üöå Bono transporte diario total</label>
                        <input type="number" id="bonoTotalConfig" value="27100" placeholder="Total diario incluyendo auxilio">
                    </div>
                    <div class="input-group">
                        <label>D√≠as laborales por semana</label>
                        <select id="diasSemanaConfig">
                            <option value="5">5 d√≠as (Lun-Vie)</option>
                            <option value="6" selected>6 d√≠as (Lun-S√°b)</option>
                        </select>
                    </div>
                </div>
                <div class="info-box">
                    üí° Bono transporte = Total diario ($27,100) - Auxilio legal diario ($249,095 √∑ 30)<br>
                    Se paga solo los d√≠as efectivamente trabajados.
                </div>
            </div>

            <div class="card">
                <h2>‚öôÔ∏è Configuraci√≥n Legal</h2>
                <div class="input-row">
                    <div class="input-group">
                        <label>¬øExonerado de parafiscales?</label>
                        <select id="exoneradoConfig">
                            <option value="true">S√≠ (Art. 114-1 E.T.)</option>
                            <option value="false">No</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Riesgo ARL</label>
                        <select id="arlConfig">
                            <option value="0.00522">Nivel I (0.522%)</option>
                            <option value="0.01044">Nivel II (1.044%)</option>
                            <option value="0.02436">Nivel III (2.436%)</option>
                            <option value="0.0435">Nivel IV (4.35%)</option>
                            <option value="0.0696">Nivel V (6.96%)</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="saveSettings()" style="margin-top:16px;">
                    üíæ Guardar Configuraci√≥n
                </button>
            </div>
            
            <div class="card">
                <h2>üóëÔ∏è Datos</h2>
                <p style="color:#8892b0;font-size:0.85rem;margin-bottom:12px;">Los datos se guardan en tu navegador.</p>
                <button class="btn btn-secondary" onclick="exportData()">üì§ Exportar</button>
                <button class="btn btn-danger" onclick="clearAllData()" style="margin-left:8px;">üóëÔ∏è Borrar todo</button>
            </div>
        </div>

        <footer>
            Datos seg√∫n Gerencie.com ‚Ä¢ Salario M√≠nimo 2026: $1,750,905
        </footer>
    </div>

    <script>
        // Constants
        const MONTHS = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        const DAYS = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'];
        
        // State
        let currentDate = new Date();
        let currentMonth = currentDate.getMonth();
        let currentYear = currentDate.getFullYear();
        let selectedType = 'worked';
        let selectedQuincena = 'all'; // 'all', 1, 2
        let summaryQuincena = 'all';
        let attendance = {};
        let history = [];
        let settings = {
            nombre: '',
            cedula: '',
            fechaIngreso: '',
            cargo: '',
            salario: 1750905,
            auxilio: 249095,
            bonoTotal: 27100,
            diasSemana: 6,
            exonerado: true,
            arl: 0.00522
        };

        // Initialize
        function init() {
            loadData();
            renderCalendar();
            updateStats();
            updateSummary();
            renderHistory();
            loadSettingsUI();
        }

        // Data persistence
        function loadData() {
            const savedAttendance = localStorage.getItem('nomina_attendance');
            const savedHistory = localStorage.getItem('nomina_history');
            const savedSettings = localStorage.getItem('nomina_settings');
            
            if (savedAttendance) attendance = JSON.parse(savedAttendance);
            if (savedHistory) history = JSON.parse(savedHistory);
            if (savedSettings) settings = { ...settings, ...JSON.parse(savedSettings) };
        }

        function saveData() {
            localStorage.setItem('nomina_attendance', JSON.stringify(attendance));
            localStorage.setItem('nomina_history', JSON.stringify(history));
            localStorage.setItem('nomina_settings', JSON.stringify(settings));
        }

        // Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`section-${section}`).classList.add('active');
            event.target.classList.add('active');
            
            if (section === 'summary') updateSummary();
            if (section === 'history') renderHistory();
        }

        function changeMonth(delta) {
            currentMonth += delta;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
            updateStats();
            updateSummary();
        }

        function setQuincena(q) {
            selectedQuincena = q;
            document.querySelectorAll('.quincena-btn:not(.summary-q)').forEach(btn => {
                btn.classList.toggle('active', 
                    (q === 'all' && btn.textContent === 'Mes') ||
                    (q === 1 && btn.textContent.includes('Q1')) ||
                    (q === 2 && btn.textContent.includes('Q2'))
                );
            });
            const label = q === 'all' ? 'del Mes' : q === 1 ? 'Quincena 1 (1-15)' : 'Quincena 2 (16-fin)';
            document.getElementById('quincenaLabel').textContent = label;
            renderCalendar();
            updateStats();
        }

        function setSummaryQuincena(q) {
            summaryQuincena = q;
            document.querySelectorAll('.summary-q').forEach(btn => {
                btn.classList.toggle('active', 
                    (q === 'all' && btn.textContent === 'Mes') ||
                    (q === 1 && btn.textContent === 'Q1') ||
                    (q === 2 && btn.textContent === 'Q2')
                );
            });
            updateSummary();
        }

        function isInQuincena(day, quincena) {
            if (quincena === 'all') return true;
            if (quincena === 1) return day >= 1 && day <= 15;
            return day >= 16;
        }

        // Calendar
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = '';
            
            // Header
            DAYS.forEach(day => {
                grid.innerHTML += `<div class="calendar-day-header">${day}</div>`;
            });
            
            // Days
            const firstDay = new Date(currentYear, currentMonth, 1).getDay();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const today = new Date();
            
            // Empty cells
            for (let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div class="calendar-day empty"></div>`;
            }
            
            // Day cells
            for (let day = 1; day <= daysInMonth; day++) {
                const dateKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayDate = new Date(currentYear, currentMonth, day);
                const dayOfWeek = dayDate.getDay();
                const isToday = dayDate.toDateString() === today.toDateString();
                const isFuture = dayDate > today;
                const isSunday = dayOfWeek === 0;
                const inQuincena = isInQuincena(day, selectedQuincena);
                const type = attendance[dateKey] || '';
                
                let classes = 'calendar-day';
                if (isToday) classes += ' today';
                if (isFuture) classes += ' future';
                if (isSunday && !type) classes += ' sunday';
                if (!inQuincena) classes += ' outside-quincena';
                if (type) classes += ` ${type}`;
                
                const indicator = type ? getIndicator(type) : (isSunday ? 'D' : '');
                
                grid.innerHTML += `
                    <div class="${classes}" onclick="toggleDay('${dateKey}', ${isFuture})" data-date="${dateKey}">
                        ${day}
                        ${indicator ? `<span class="indicator">${indicator}</span>` : ''}
                    </div>
                `;
            }
            
            document.getElementById('monthYear').textContent = `${MONTHS[currentMonth]} ${currentYear}`;
        }

        function getIndicator(type) {
            const indicators = {
                worked: '‚úì',
                absent: '‚úó',
                vacation: 'üèñ',
                sick: 'üè•',
                holiday: 'üéâ',
                half: '¬Ω'
            };
            return indicators[type] || '';
        }

        function selectType(type) {
            selectedType = type;
            document.querySelectorAll('.legend-item').forEach(item => {
                item.classList.toggle('selected', item.dataset.type === type);
            });
        }

        function toggleDay(dateKey, isFuture) {
            if (isFuture) return;
            
            if (attendance[dateKey] === selectedType) {
                delete attendance[dateKey];
            } else {
                attendance[dateKey] = selectedType;
            }
            
            saveData();
            renderCalendar();
            updateStats();
        }

        // Stats
        function updateStats() {
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const counts = { worked: 0, absent: 0, vacation: 0, sick: 0, holiday: 0, half: 0, sundays: 0 };
            
            // Count Sundays in selected quincena
            for (let day = 1; day <= daysInMonth; day++) {
                if (!isInQuincena(day, selectedQuincena)) continue;
                const date = new Date(currentYear, currentMonth, day);
                if (date.getDay() === 0) counts.sundays++;
            }
            
            Object.entries(attendance).forEach(([date, type]) => {
                if (!date.startsWith(monthKey)) return;
                const day = parseInt(date.split('-')[2]);
                if (!isInQuincena(day, selectedQuincena)) return;
                counts[type] = (counts[type] || 0) + 1;
            });
            
            document.getElementById('statWorked').textContent = counts.worked + (counts.half * 0.5);
            document.getElementById('statAbsent').textContent = counts.absent + (counts.half * 0.5);
            document.getElementById('statVacation').textContent = counts.vacation;
            document.getElementById('statSick').textContent = counts.sick;
            document.getElementById('statHoliday').textContent = counts.holiday;
            document.getElementById('statSundays').textContent = counts.sundays;
        }

        // Summary calculation
        function updateSummary() {
            const monthKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Period label
            let periodLabel = `${MONTHS[currentMonth]} ${currentYear}`;
            let daysInPeriod = daysInMonth;
            if (summaryQuincena === 1) {
                periodLabel = `${MONTHS[currentMonth]} 1-15, ${currentYear}`;
                daysInPeriod = 15;
            } else if (summaryQuincena === 2) {
                periodLabel = `${MONTHS[currentMonth]} 16-${daysInMonth}, ${currentYear}`;
                daysInPeriod = daysInMonth - 15;
            }
            document.getElementById('summaryPeriod').textContent = periodLabel;
            
            // Count days
            let paidDays = 0; // For salary (worked + holiday + vacation)
            let workedDays = 0; // For transport bonus (only worked)
            
            Object.entries(attendance).forEach(([date, type]) => {
                if (!date.startsWith(monthKey)) return;
                const day = parseInt(date.split('-')[2]);
                if (!isInQuincena(day, summaryQuincena)) return;
                
                if (type === 'worked') {
                    paidDays += 1;
                    workedDays += 1;
                } else if (type === 'holiday' || type === 'vacation') {
                    paidDays += 1;
                    // No transport bonus on holidays/vacation
                } else if (type === 'half') {
                    paidDays += 0.5;
                    workedDays += 0.5;
                } else if (type === 'sick') {
                    paidDays += 0.6667;
                    // No transport bonus on sick days
                }
            });
            
            // Calculate proportional factor for the period
            const factor = paidDays / 30;
            const salario = settings.salario * factor;
            const auxilioLegal = settings.auxilio * factor;
            
            // Transport bonus: only for worked days
            const auxilioDiario = settings.auxilio / 30;
            const bonoDiario = settings.bonoTotal - auxilioDiario;
            const bonoTransporte = bonoDiario * workedDays;
            
            const totalDevengadoBruto = salario + auxilioLegal + bonoTransporte;
            
            // Worker deductions (on salary only)
            const descSalud = salario * 0.04;
            const descPension = salario * 0.04;
            const netoPagar = totalDevengadoBruto - descSalud - descPension;
            
            // Benefits (on salary + legal transport, not bonus)
            const basePresaciones = salario + auxilioLegal;
            const prima = basePresaciones * 0.0833;
            const cesantias = basePresaciones * 0.0833;
            const intCesantias = cesantias * 0.12;
            const vacaciones = salario * 0.0417;
            const totalPrestaciones = prima + cesantias + intCesantias + vacaciones;
            
            // Employer social security (on salary only)
            const aportesPension = salario * 0.12;
            const aportesARL = salario * settings.arl;
            const aportesSalud = settings.exonerado ? 0 : salario * 0.085;
            const totalSegSocial = aportesPension + aportesARL + aportesSalud;
            
            // Parafiscales (on salary only)
            const cajaComp = salario * 0.04;
            const sena = settings.exonerado ? 0 : salario * 0.02;
            const icbf = settings.exonerado ? 0 : salario * 0.03;
            const totalParafiscales = cajaComp + sena + icbf;
            
            const costoTotal = totalDevengadoBruto + totalPrestaciones + totalSegSocial + totalParafiscales;
            
            // Update UI
            document.getElementById('diasPagar').textContent = paidDays.toFixed(1);
            document.getElementById('diasBono').textContent = workedDays;
            document.getElementById('bonoValor').textContent = Math.round(bonoDiario).toLocaleString('es-CO');
            document.getElementById('salarioBase').textContent = formatCurrency(salario);
            document.getElementById('auxTransporte').textContent = formatCurrency(auxilioLegal);
            document.getElementById('bonoTransporte').textContent = formatCurrency(bonoTransporte);
            document.getElementById('descSalud').textContent = '-' + formatCurrency(descSalud);
            document.getElementById('descPension').textContent = '-' + formatCurrency(descPension);
            document.getElementById('netoPagar').textContent = formatCurrency(netoPagar);
            
            document.getElementById('totalDevengado').textContent = formatCurrency(totalDevengadoBruto);
            document.getElementById('prestaciones').textContent = formatCurrency(totalPrestaciones);
            document.getElementById('segSocial').textContent = formatCurrency(totalSegSocial);
            document.getElementById('parafiscales').textContent = formatCurrency(totalParafiscales);
            document.getElementById('costoTotal').textContent = formatCurrency(costoTotal);
            
            document.getElementById('prima').textContent = formatCurrency(prima);
            document.getElementById('cesantias').textContent = formatCurrency(cesantias);
            document.getElementById('intCesantias').textContent = formatCurrency(intCesantias);
            document.getElementById('vacaciones').textContent = formatCurrency(vacaciones);
            
            return { paidDays, workedDays, netoPagar, costoTotal, bonoTransporte };
        }

        function formatCurrency(value) {
            return '$' + Math.round(value).toLocaleString('es-CO');
        }

        // History
        function saveQuincena() {
            const { paidDays, workedDays, netoPagar, costoTotal, bonoTransporte } = updateSummary();
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            let periodKey, periodName;
            if (summaryQuincena === 'all') {
                periodKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
                periodName = `${MONTHS[currentMonth]} ${currentYear}`;
            } else if (summaryQuincena === 1) {
                periodKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-Q1`;
                periodName = `${MONTHS[currentMonth]} 1-15, ${currentYear}`;
            } else {
                periodKey = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-Q2`;
                periodName = `${MONTHS[currentMonth]} 16-${daysInMonth}, ${currentYear}`;
            }
            
            // Remove existing entry
            history = history.filter(h => h.period !== periodKey);
            
            history.push({
                period: periodKey,
                periodName,
                paidDays,
                workedDays,
                netoPagar,
                costoTotal,
                bonoTransporte,
                savedAt: new Date().toISOString()
            });
            
            history.sort((a, b) => b.period.localeCompare(a.period));
            saveData();
            alert('‚úÖ Liquidaci√≥n guardada');
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('historyList');
            
            if (history.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="icon">üì≠</div>
                        <p>No hay liquidaciones guardadas</p>
                    </div>
                `;
                document.getElementById('totalPagado').textContent = '$0';
                document.getElementById('totalCosto').textContent = '$0';
                document.getElementById('totalBono').textContent = '$0';
                document.getElementById('totalDias').textContent = '0';
                document.getElementById('totalVacaciones').textContent = '0 d√≠as';
                return;
            }
            
            list.innerHTML = history.map(h => `
                <div class="history-item">
                    <div>
                        <div class="history-month">${h.periodName}</div>
                        <div class="history-details">${h.workedDays || h.paidDays} d√≠as trabajados</div>
                    </div>
                    <div class="history-amount">${formatCurrency(h.netoPagar)}</div>
                </div>
            `).join('');
            
            // Totals
            const totals = history.reduce((acc, h) => ({
                pagado: acc.pagado + h.netoPagar,
                costo: acc.costo + h.costoTotal,
                dias: acc.dias + (h.workedDays || h.paidDays),
                bono: acc.bono + (h.bonoTransporte || 0)
            }), { pagado: 0, costo: 0, dias: 0, bono: 0 });
            
            // Count vacation days
            let vacationDays = 0;
            Object.entries(attendance).forEach(([date, type]) => {
                if (type === 'vacation') vacationDays++;
            });
            
            document.getElementById('totalPagado').textContent = formatCurrency(totals.pagado);
            document.getElementById('totalCosto').textContent = formatCurrency(totals.costo);
            document.getElementById('totalBono').textContent = formatCurrency(totals.bono);
            document.getElementById('totalDias').textContent = totals.dias.toFixed(1);
            document.getElementById('totalVacaciones').textContent = `${vacationDays} d√≠as`;
        }

        // Settings
        function loadSettingsUI() {
            document.getElementById('empNombre').value = settings.nombre || '';
            document.getElementById('empCedula').value = settings.cedula || '';
            document.getElementById('empFechaIngreso').value = settings.fechaIngreso || '';
            document.getElementById('empCargo').value = settings.cargo || '';
            document.getElementById('salarioConfig').value = settings.salario;
            document.getElementById('auxilioConfig').value = settings.auxilio;
            document.getElementById('bonoTotalConfig').value = settings.bonoTotal || 27100;
            document.getElementById('diasSemanaConfig').value = settings.diasSemana || 6;
            document.getElementById('exoneradoConfig').value = String(settings.exonerado);
            document.getElementById('arlConfig').value = settings.arl;
        }

        function saveSettings() {
            settings.nombre = document.getElementById('empNombre').value;
            settings.cedula = document.getElementById('empCedula').value;
            settings.fechaIngreso = document.getElementById('empFechaIngreso').value;
            settings.cargo = document.getElementById('empCargo').value;
            settings.salario = parseInt(document.getElementById('salarioConfig').value) || 1750905;
            settings.auxilio = parseInt(document.getElementById('auxilioConfig').value) || 249095;
            settings.bonoTotal = parseInt(document.getElementById('bonoTotalConfig').value) || 27100;
            settings.diasSemana = parseInt(document.getElementById('diasSemanaConfig').value) || 6;
            settings.exonerado = document.getElementById('exoneradoConfig').value === 'true';
            settings.arl = parseFloat(document.getElementById('arlConfig').value);
            
            saveData();
            alert('‚úÖ Configuraci√≥n guardada');
            updateSummary();
        }

        function exportData() {
            const data = {
                settings,
                attendance,
                history,
                exportedAt: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `nomina-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function clearAllData() {
            if (confirm('‚ö†Ô∏è ¬øEst√°s seguro? Se borrar√°n todos los datos.')) {
                localStorage.removeItem('nomina_attendance');
                localStorage.removeItem('nomina_history');
                localStorage.removeItem('nomina_settings');
                location.reload();
            }
        }

        // Init
        init();
    </script>
</body>
</html>
